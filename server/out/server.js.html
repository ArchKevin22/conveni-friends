<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import express from "express";
import http from "http";
import mysql from "mysql";

const db = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: '',
    database: 'cs130_project',
});

const app = express();
const server = http.Server(app);
const PORT = 3000;
const HttpStatus = require('http-status-codes');

// HTTP body parser
var bodyParser = require('body-parser');
var multer = require('multer'); // v1.0.5
var upload = multer(); // for parsing multipart/form-data
app.use(bodyParser.json()); // for parsing application/json
app.use(bodyParser.urlencoded({ extended: true })); // for parsing application/x-www-form-urlencoded

// TODO: We should split up the routes into separate files .. one for
// user endpoints, request endpoints, etc.

// TODO: I think we could create our own function that handles the db queries
// so that we can define a way to handle errors

app.get('/', (req, res) => {
    res.send("Test GET request");
});

/**
 * Called when a user first signs up for Convenifriends.
 *
 * Example call:
 * http://localhost:3000/v1/user/testUserId/signup
 *
 * @name /v1/user/{userId}/signup
 *
 * @version 1
 * @param {string} userId - The user's desired username.
 * @param {string} password - The user's password.
 * @returns {res} The response, including an HTTP status indicating success or failure, and error info, if any.
 */
app.post('/v1/user/:userId/signup', upload.array(), (req, res) => {
    const userId = req.params.userId;
    const password = req.body['password'];

    const query = `INSERT INTO User(userId,password) ` +
                  `VALUES("${userId}","${password}")`;

    db.query(query, (error, results) => {
        if (error) {
            console.log(error.message);
            res.send(false);
        } else {
            console.log("SUCCESS!");
            console.log(results);
            res.send(true)
        }
    });
});

/********************************** USERS **********************************/

/**
 * Called when a user logs into Convenifriends.
 *
 * Example call:
 * http://localhost:3000/v1/user/testUserId/login
 *
 * @name /v1/user/{userId}/login
 *
 * @version 1
 * @param {string} userId - The user's username.
 * @param {string} password - The user's password.
 * @returns {res} The response, including an HTTP status indicating success or failure, and error info, if any.
 */
app.post('/v1/user/:userId/login', upload.array(), (req, res) => {
    const userId = req.params.userId;
    const password = req.body['password'];

    const query = `SELECT * FROM User ` +
                  `WHERE password="${password}" and userId="${userId}"`;

    db.query(query, (error, results) => {
        if (error) {
            console.log(error.message);
            res.send(false);
        } else {
            console.log("SUCCESS!");
            console.log(results);
            res.send(true)
        }
    });
});

/**
 * Called when a user updates their password in Convenifriends.
 *
 * Example call:
 * http://localhost:3000/v1/user/testUserId/update
 *
 * @name /v1/user/{userId}/update
 *
 * @version 1
 * @param {string} userId - The user's username.
 * @param {string} password - The user's old password.
 * @param {string} newPassword - The user's new password.
 * @returns {res} The response, including an HTTP status indicating success or failure, and error info, if any.
 */
app.post('/v1/user/:userId/update', upload.array(), (req, res) => {
    const userId = req.params.userId;
    const password = req.body['password'];
    const newPassword = req.body['newPassword'];

    const query = `UPDATE User SET password="${newPassword}" ` +
                  `WHERE userId="${userId}"`;

    db.query(query, (error, results) => {
        if (error) {
            console.log(error.message);
            res.send(false);
        } else {
            console.log("SUCCESS!");
            console.log(results);
            res.send(true)
        }
    });
});

/********************************** REQUESTS **********************************/

/**
 * Called when a user creates a new request.
 *
 * @name /v1/request/create
 *
 * @version 1
 * @param {string} userId - The user's username.
 * @param {string} title - The title of the request.
 * @param {string} description - A description of the user's request.
 * @param {float} latitude - The latitude of the request's location.
 * @param {float} longitude - The longitude of the request's location.
 * @param {string} address - The address of the request's location.
 * @param {string} timeStart - The time the request was made.
 * @param {string} timeEnd - The time the request expires.
 * @returns {res} The response, including an HTTP status indicating success or failure. In the case of success, a requestId is also returned, and error info is returned in case of a failure.
 */
app.post('/v1/request/create', (req, res) => {
    // In practice, will use req.params, but easier to modify the URL
    // query params during development

    // We're also currently assuming that the frontend passes strings like
    // "string" rather than string.
    const { userId, title, description } = req.query;
    const { latitude, longitude, address, timeStart, timeEnd } = req.query;

    // TODO: Gotta figure out a more cleaner way to do our queries ..
    const query = `INSERT INTO Request(requesterId,title,latitude, ` +
                  `longitude,address,description,timeStart,timeEnd) ` +
                  `VALUES(${userId},${title},${latitude},${longitude},` +
                  `${address},${description},${timeStart},${timeEnd})`;

    db.query(query, (error, results) => {
        if (error) {
            console.log(error);
            res.status(HttpStatus.INTERNAL_SERVER_ERROR)
               .send({ message: error.message });
        }
        else {
            console.log("Success");
            res.status(HttpStatus.OK).send({});
        }
    });
});

/**
 * Called when a user deletes one of their existing requests.
 *
 * Example call:
 * http://localhost:3000/v1/request/1/delete?userId="test"
 *
 * @name /v1/request/{requestId}/delete
 *
 * @version 1
 * @param {int} requestId - The id of the request to be deleted.
 * @param {string} userId - The user's username.
 * @returns {res} The response, including an HTTP status indicating success or failure, and error info, if any.
 */
app.post('/v1/request/:requestId/delete', (req, res) => {
    const requestId = req.params.requestId;
    const { userId } = req.query;

    const query = `DELETE FROM Request ` +
                  `WHERE requestId=${requestId} AND requesterId=${userId}`;

    db.query(query, (error, results) => {
        if (error) {
            console.log(error);
            res.status(HttpStatus.INTERNAL_SERVER_ERROR)
               .send({ message: error.message });
        } else {
            // Request doesn't exist or is expired
            if (results.affectedRows &lt;= 0) {
                const err = "Request doesn't exist or is expired.";
                console.log(err);
                res.status(HttpStatus.NOT_FOUND).send({ message: err });

            // Delete succesful
            } else {
                console.log("Success");
                res.status(HttpStatus.OK).send({});
            }
        }
    });
});

/**
 * Called when a provider accepts a nearby unaccepted request.
 *
 * Example call:
 * http://localhost:3000/v1/request/1/accept?userId="test"&amp;time="2017-04-04%2011:11:011"
 *
 * @name /v1/request/{requestId}/accept
 *
 * @version 1
 * @param {int} requestId - The id of the request to be accepted.
 * @param {string} userId - The provider's username.
 * @param {string} time - The time of acceptance.
 * @returns {res} The response, including an HTTP status indicating success or failure, and error info, if any.
 */
app.post('/v1/request/:request_id/accept', (req, res) => {
    const requestId = req.params.request_id;
    const { userId, time } = req.query;

    const query = `UPDATE Request ` +
                  `SET accepted=${time}, providerId=${userId} ` +
                  `WHERE requestId=${requestId} AND ${time} &lt; timeEnd;`

    db.query(query, (error, results) => {
        if (error) {
            res.status(HttpStatus.INTERNAL_SERVER_ERROR)
               .send({ message: "Internal server error." });
        } else {
            // Request doesn't exist or is expired
            if (results.affectedRows &lt;= 0) {
                const err = "Request doesn't exist or is expired.";
                console.log(err);
                res.status(HttpStatus.NOT_FOUND).send({ message: err });

            // Accept succesful
            } else {
                console.log("Success");
                res.status(HttpStatus.OK).send({});
            }
        }
    });
});

/**
 * Called when a requester confirms the acceptance of one of their requests.
 *
 * Example call:
 * http://localhost:3000/v1/request/1/confirm?userId="test"&amp;time="2017-04-04%2011:11:011"
 *
 * @name /v1/request/{requestId}/confirm
 *
 * @version 1
 * @param {int} requestId - The id of the request to be confirmed.
 * @param {string} userId - The requester's username.
 * @param {string} time - The time of confirmation.
 * @returns {res} The response, including an HTTP status indicating success or failure, and error info, if any.
 */
app.post('/v1/request/:request_id/confirm', (req, res) => {
    const requestId = req.params.request_id;
    const { userId, time } = req.query;

    const query = `UPDATE Request ` +
                  `SET confirmed=${time}, providerId=${userId} ` +
                  `WHERE requestId=${requestId} AND ${time} &lt; timeEnd;`

    db.query(query, (error, results) => {
        if (error) {
            res.status(HttpStatus.INTERNAL_SERVER_ERROR)
               .send({ message: "Internal server error." });
        } else {
            // Request doesn't exist or is expired
            if (results.affectedRows &lt;= 0) {
                const err = "Request doesn't exist or is expired.";
                console.log(err);
                res.status(HttpStatus.NOT_FOUND).send({ message: err });

            // Confirm succesful
            } else {
                console.log("Success");
                res.status(HttpStatus.OK).send({});
            }
        }
    });
});

/**
 * Called when a provider completes one of their confirmed requests.
 *
 * Example call:
 * http://localhost:3000/v1/request/1/complete?userId="test"&amp;time="2017-04-04%2011:11:011"
 *
 * @name /v1/request/{requestId}/complete
 *
 * @version 1
 * @param {int} requestId - The id of the request to be completed.
 * @param {string} userId - The provider's username.
 * @param {string} time - The time of completion.
 * @returns {res} The response, including an HTTP status indicating success or failure, and error info, if any.
 */
app.post('/v1/request/:requestId/complete', (req, res) => {
    const { userId, time } = req.query;
    const { requestId } = req.params;

    const query = `UPDATE Request SET completed=${time} `
                + `WHERE requestId=${requestId} AND ${time} &lt; timeEnd`;

    db.query(query, (error, results) => {
        if (error) {
            res.status(HttpStatus.INTERNAL_SERVER_ERROR)
               .send({ message: "Internal server error." });
        } else {
            // Request doesn't exist or is expired
            if (results.affectedRows &lt;= 0) {
                const err = "Request doesn't exist or is expired.";
                console.log(err);
                res.status(HttpStatus.NOT_FOUND).send({ message: err });

            // Complete succesful
            } else {
                console.log("Success");
                res.status(HttpStatus.OK).send({});
            }
        }
    });
});

/**
 * Called when a user looks up their existing requests.
 *
 * @name /v1/user/{userId}/requests
 *
 * @version 1
 * @param {int} userId - The username of the user.
 * @returns {res} The response, including an HTTP status indicating success or failure, and the relevant requests. In the case of error, the response contains error info.
 */
app.get('/v1/user/:userId/requests', (req, res) => {
    const { userId } = req.params;

    const query = `SELECT * FROM Request `
                + `WHERE requesterId="${userId}" OR providerId="${userId}"`;

    db.query(query, (error, results) => {
        console.log(error || "Success");
        res.send(results || error);
    });
});

/**
 * Called when a user looks up nearby requests.
 *
 * Example call:
 * http://localhost:3000/v1/requests/all?userId="test"&amp;latitude="30"&amp;longitude="30"
 *
 * @name /v1/requests/all
 *
 * @version 1
 * @param {int} userId - The username of the user.
 * @param {float} latitude - The current latitude of the user.
 * @param {float} longitude - The current longitude of the user.
 * 
 * @returns {res} The response, including an HTTP status indicating success or failure, and the relevant requests. In the case of error, the response contains error info.
 */
app.get('/v1/requests/all', (req, res) => {
    const { userId, latitude, longitude } = req.query;

    // Check within a set box with a magic number (long/lat of 0.1 in this case) for now
    const query = `SELECT * FROM Request ` +
                  `WHERE accepted is NULL ` +
                  `AND latitude &lt;= (${latitude} + 0.1) AND latitude >= (${latitude} - 0.1) ` +
                  `AND longitude &lt;= (${longitude} + 0.1) AND longitude >= (${longitude} - 0.1)`;

    db.query(query, (error, results) => {
        console.log(error || "Success")
        res.send(results || error);
    });
});


server.listen(PORT, () => {
    db.connect();
    console.log(`Listening on ${PORT}`);
});

export default server;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#/v1/request/create">/v1/request/create</a></li><li><a href="global.html#/v1/request/%257BrequestId%257D/accept">/v1/request/{requestId}/accept</a></li><li><a href="global.html#/v1/request/%257BrequestId%257D/complete">/v1/request/{requestId}/complete</a></li><li><a href="global.html#/v1/request/%257BrequestId%257D/confirm">/v1/request/{requestId}/confirm</a></li><li><a href="global.html#/v1/request/%257BrequestId%257D/delete">/v1/request/{requestId}/delete</a></li><li><a href="global.html#/v1/requests/all">/v1/requests/all</a></li><li><a href="global.html#/v1/user/%257BuserId%257D/login">/v1/user/{userId}/login</a></li><li><a href="global.html#/v1/user/%257BuserId%257D/requests">/v1/user/{userId}/requests</a></li><li><a href="global.html#/v1/user/%257BuserId%257D/signup">/v1/user/{userId}/signup</a></li><li><a href="global.html#/v1/user/%257BuserId%257D/update">/v1/user/{userId}/update</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Nov 16 2017 16:02:16 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
